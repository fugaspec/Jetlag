import { DateTime } from 'luxon';
import nodemailer from 'nodemailer';
import { Redis } from '@upstash/redis';

const UPSTASH_URL = process.env.UPSTASH_REDIS_REST_URL || process.env.KV_REST_API_URL || '';
const UPSTASH_TOKEN = process.env.UPSTASH_REDIS_REST_TOKEN || process.env.KV_REST_API_TOKEN || '';
const hasKv = !!UPSTASH_URL && !!UPSTASH_TOKEN && /^https?:\/\//.test(UPSTASH_URL);
const redis = hasKv ? new Redis({ url: UPSTASH_URL, token: UPSTASH_TOKEN }) : null;

const transporter = nodemailer.createTransport({
  host: 'smtp.gmail.com',
  port: 465,
  secure: true,
  auth: { user: process.env.GMAIL_USER, pass: process.env.GMAIL_PASS },
});

export default async function handler(req: any, res: any) {
  try {
    if (!redis) return res.status(200).json({ ok: true, sent: 0, note: 'kv disabled' });

    const nowUtc = DateTime.utc();
    const key = `queue:${nowUtc.toFormat('yyyyLLddHHmm')}`;
    const items = await redis.lrange<string>(key, 0, -1);
    await redis.del(key);

    if (!items?.length) return res.status(200).json({ ok: true, sent: 0 });

    let sent = 0;
    for (const raw of items) {
      try {
        const job = JSON.parse(raw) as {
          email: string;
          route: string;
          dest_country: string;
          arrive_local_full: string;
          arrive_local_hm: string;
          send_at_utc: string;
        };

        const subject = `Arrival — ${job.route}`;
        const text =
`We have just landed in ${job.dest_country}

"Souls can't move that quickly, and are left behind, and must be awaited, upon arrival, like lost luggage."
William Gibson "Pattern Recognition"

- The Perfect Jet Lag

Cooperated with Genelec Japan`;

        const html = `<!doctype html><html><head><meta charset=\"utf-8\"></head><body style=\"margin:0;padding:24px;background:#f7f7f7;\">
  <div style=\"max-width:560px;margin:0 auto;background:#fff;padding:24px;border:1px solid #eee;\">
    <div style=\"font-family:'OCRB','OCR-B','OCRB Std','OCR A',monospace;letter-spacing:0.5px;line-height:1.8;font-size:16px;color:#111;\">
      <div>We have just landed in <strong>${job.dest_country}</strong></div>
      <div style=\"margin:14px 0 0 0;white-space:pre-wrap;\">\"Souls can't move that quickly, and are left behind, and must be awaited, upon arrival, like lost luggage.\"\nWilliam Gibson \"Pattern Recognition\"</div>
      <div style=\"margin-top:18px;\">- The Perfect Jet Lag</div>
      <div style=\"margin-top:16px;font-size:12px;opacity:.7;\">Cooperated with Genelec Japan</div>
    </div>
  </div>
  </body></html>`;

        await transporter.sendMail({
          from: process.env.MAIL_FROM,
          to: job.email,
          subject,
          text,
          html,
        });
        sent++;
      } catch (e) {
        console.error('[dispatch] send error', e);
      }
    }

    return res.status(200).json({ ok: true, sent });
  } catch (e: any) {
    return res.status(500).json({ error: e?.message || 'Server Error' });
  }
}
<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>UI moved — See /</title>
<style>body{font-family:system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", sans-serif;margin:32px;line-height:1.7}a{color:#06f;text-decoration:none}a:hover{text-decoration:underline}</style>
</head>
<body>
  <h1>The Perfect Jet Lag — UI はトップに移動しました</h1>
  <p>このページは開発時の残骸です。現在の UI は <a href="/">トップページ</a>（<code>index.html</code>）で公開中。</p>
  <p>スマホ対応／Genelec表記は <code>index.html</code> に反映済み。</p>
</body>
</html>
